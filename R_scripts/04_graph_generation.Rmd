---
title: "Plot Generation - all reserves, all SETs"
author: "Kim Cressman"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

I'm going to loop through all reserves and spit out consistent plots for all of them. Using Rmd so they all show up in one document, but I'll also be saving them out.  

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(janitor)
library(readxl)
library(lubridate)
library(here)
library(ggplot2)
library(forcats)
library(leaflet)
library(mapview)
source(here::here("R_scripts", "sourced", "000_functions.R"))
```


Read in metadata, sea level files, and file with rates and CIs for each SET.  

```{r}
in_path <- here::here("data", "intermediate", "rate_summary.csv")
dat_rates <- read.csv(in_path, stringsAsFactors = FALSE)

in_path <- here::here("data", "intermediate", "rate_comparisons.csv")
dat_slr_comps <- read.csv(in_path, stringsAsFactors = FALSE)

in_path <- here::here("data", "processed_combined", "all_sites.csv")
dat_all <- read.csv(in_path, stringsAsFactors = FALSE) %>% 
  mutate(date = lubridate::ymd(date))

slr_path <- here::here("metadata", "slr_rates.csv")
slr_rates <- read.csv(slr_path, stringsAsFactors = FALSE) %>% 
  clean_names() %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  mutate(slr_CI_low = slr_rate_mm_yr - x_95_ci,
         slr_CI_high = slr_rate_mm_yr + x_95_ci)
```



```{r}
reserves <- unique(dat_rates$reserve)
```


Loop through reserves and:  

+  create the "star wars" rate summary graph  
+  perform cumulative change calculations and make that graph  
+  print the maps

```{r}
for(i in seq_along(reserves)){
        
        # subset the data
        to_plo <- dat_rates[dat_rates$reserve == reserves[i], ]
        to_calc <- dat_all[dat_all$reserve == reserves[i], ]

        
        # pull SLR rate and CI out of metadata
        slr <- unlist(slr_rates[slr_rates$reserve == reserves[i], "slr_rate_mm_yr"])
        slr_ci <- unlist(slr_rates[slr_rates$reserve == reserves[i], "x_95_ci"])
        
        
        # get the correct order of SETs for the summary graph:
        
        # first: no NAs in either column; use user-friendly SET ID and put it in order
        if(!anyNA(to_plo$numerical_order) & !anyNA(to_plo$user_friendly_set_name)){
                a <- forcats::fct_reorder(to_plo$user_friendly_set_name,
                                          desc(to_plo$numerical_order))
                to_plo$graph_set_name <- a
                
        # second: no NAs in numerical_order only: use set_id, but put it in order
        } else if (!anyNA(to_plo$numerical_order)) {
                b <- forcats::fct_reorder(to_plo$set_id,
                                          desc(to_plo$numerical_order))
                to_plo$graph_set_name <- b
            
                
        # last: if neither are given, just use set names but make them factors and reverse them so the first in the alphabet will be at the top
        } else {
                c <- factor(to_plo$set_id)
                d <- forcats::fct_relevel(c, rev)
                to_plo$graph_set_name <- d
        }
        
        
        
        # perform cumulative change calculations and get the correct SET order for the cumulative change graph (only using SET ID for now)
        cumu_temp <- calc_change_cumu(to_calc)
        set_temp <- cumu_temp$set
        if (!anyNA(to_plo$numerical_order)){
          mdat_sub <- select(to_plo, set_id, numerical_order)
          set_temp <- left_join(set_temp, mdat_sub) %>% 
            mutate(set_id = fct_reorder(set_id, numerical_order)) %>% 
            select(-numerical_order)
          }    
        

        # make the plots
        
        ### STAR WARS PLOT
        # deal with new args
        p <- plot_rate_comps(set_temp)
          
          # ggplot() +
          #       geom_blank(data = to_plo, 
          #                  aes(x = graph_set_name, 
          #                      y = rate_full)) +
          #       geom_ribbon(aes(x = 0:(nrow(to_plo)+1), 
          #                       ymin = slr-slr_ci, 
          #                       ymax = slr+slr_ci), 
          #                   fill = "navyblue", 
          #                   alpha = 0.1) +
          #       geom_hline(aes(yintercept = slr), 
          #                  col = "navyblue", 
          #                  size = 1, 
          #                  alpha = 0.9) +
          #       geom_hline(aes(yintercept = 0), 
          #                  col = "gray70") +
          #       geom_errorbar(data = to_plo, 
          #                     aes(x = graph_set_name, 
          #                         ymin = CI_low_full, 
          #                         ymax = CI_high_full), 
          #                     col = "gray55", 
          #                     size = 1) +
          #       geom_point(data = to_plo, 
          #                  aes(x = graph_set_name, 
          #                      y = rate_full), 
          #                  size = 3, 
          #                  col = "red3") +
          #       theme_classic() + 
          #       labs(title = paste0(reserves[i], ", Elevation Change, 95% Confidence Intervals (LMM)"), 
          #            subtitle = paste0("Local SLR in blue: ", 
          #                              slr, " +/- ", 
          #                              slr_ci, " mm/yr"), 
          #            x = "SET", 
          #            y = "Rate of change (mm/yr)") +
          #       coord_flip()
       
        # print and save the plot 
        print(p)
        filename <- paste0(reserves[i], "_summary_plot.png")
        out_path <- here::here("R_output", "figures", "summary_plots", filename)
        ggsave(filename = out_path, plot = p, width = 7, height = 5, units = "in")
        
        
        
        ### CUMULATIVE CHANGE GRAPH
        q <- plot_cumu_set(cumu_temp$set) +
          ggtitle(paste0(reserves[i], ", Cumulative Change since first reading"))
        
        # print and save it
        print(q)
        filename <- paste0(reserves[i], "_cumu_change_plot.png")
        out_path <- here::here("R_output", "figures", "cumu_change_plots", filename)
        ggsave(filename = out_path, plot = q, width = 7, height = 8, units = "in")
        
        
        
        ### MAPS
        
        # comparison to 0
        
        
        # comparison to long-term SLR
        
        
        # comparison to 19-year change
        
        
        # pull in the images and print them?
        # knitr::include_graphics(file_path2)
        
}

```

