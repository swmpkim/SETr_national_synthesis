---
title: "Plot Generation - all reserves, all SETs"
author: "Kim Cressman"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

I'm going to loop through all reserves and spit out consistent plots for all of them. Using Rmd so they all show up in one document, but I'll also be saving them out.  

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(janitor)
library(readxl)
library(lubridate)
library(here)
library(ggplot2)
library(forcats)
library(leaflet)
library(mapview)
source(here::here("R_scripts", "sourced", "000_functions.R"))
```


Read in metadata, sea level files, and file with rates and CIs for each SET.  

```{r}
in_path <- here::here("data", "intermediate", "rate_summary.csv")
dat_rates <- read.csv(in_path, stringsAsFactors = FALSE)

in_path <- here::here("data", "intermediate", "rate_comparisons.csv")
dat_slr_comps <- read.csv(in_path, stringsAsFactors = FALSE)

in_path <- here::here("data", "processed_combined", "all_sites.csv")
dat_all <- read.csv(in_path, stringsAsFactors = FALSE) %>% 
  mutate(date = lubridate::ymd(date))

slr_path <- here::here("metadata", "slr_rates.csv")
slr_rates <- read.csv(slr_path, stringsAsFactors = FALSE) %>% 
  clean_names() %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  mutate(slr_CI_low = slr_rate_mm_yr - x_95_ci,
         slr_CI_high = slr_rate_mm_yr + x_95_ci)
```



```{r}
reserves <- unique(dat_rates$reserve)
```


```{r map_prep}
# read in images to use as map icons
icon_inc_sig_path <- here::here("img", "blue_up_arrow.png")
icon_dec_sig_path <- here::here("img", "red_down_arrow.png")
icon_inc_nonsig_path <- here::here("img", "gray_up_arrow.png")
icon_dec_nonsig_path <- here::here("img", "gray_down_arrow.png")
icon_nonsig_path <- here::here("img", "gray_dash.png")

# make the icons
icon_inc_siga <- icon_inc_sigb <- makeIcon(iconUrl = icon_inc_sig_path, 
                                           iconWidth = 30, 
                                           iconHeight = 35)
icon_dec_siga <- icon_dec_sigb <- makeIcon(iconUrl = icon_dec_sig_path, 
                                           iconWidth = 30, 
                                           iconHeight = 35)
icon_inc_nonsiga <- icon_inc_nonsigb <- makeIcon(iconUrl = icon_inc_nonsig_path, 
                                                 iconWidth = 30, 
                                                 iconHeight = 35)
icon_dec_nonsiga <- icon_dec_nonsigb <- makeIcon(iconUrl = icon_dec_nonsig_path, 
                                                 iconWidth = 30, 
                                                 iconHeight = 35)
icon_nonsiga <- icon_nonsigb <- makeIcon(iconUrl = icon_nonsig_path, 
                                         iconWidth = 25, 
                                         iconHeight = 12)


# specify what these colors are, for the legends
map_pal <- c("#c00000", "#2f5597", "#7f7f7f")
```

Loop through reserves and:  

+  create the "star wars" rate summary graph  
+  perform cumulative change calculations and make that graph  
+  make a map

```{r}
for(i in seq_along(reserves)){
        
        # subset the data
        to_plo <- dat_rates[dat_rates$reserve == reserves[i], ]
        to_calc <- dat_all[dat_all$reserve == reserves[i], ]

        
        # pull SLR rate and CI out of metadata
        slr <- unlist(slr_rates[slr_rates$reserve == reserves[i], "slr_rate_mm_yr"])
        slr_ci <- unlist(slr_rates[slr_rates$reserve == reserves[i], "x_95_ci"])
        
        
        # generate some comparisons for the maps
        to_map <- to_plo %>% 
          mutate(dir_0 = case_when(CI_high_full < 0 ~ "dec_sig",
                                   CI_low_full > 0  ~ "inc_sig",
                                   rate_full < 0 ~ "dec_nonsig",
                                   rate_full > 0 ~ "inc_nonsig",
                                   TRUE ~ "nonsig"),
                 dir_slr = case_when(CI_high_full < slr - slr_ci ~ "dec_sig",
                                     CI_low_full > slr + slr_ci  ~ "inc_sig",
                                     rate_full < slr ~ "dec_nonsig",
                                     rate_full > slr ~ "inc_nonsig",
                                     TRUE ~ "nonsig"))
        
        

        # get the correct order of SETs for the summary graph:
        
        # first: no NAs in either column; use user-friendly SET ID and put it in order
        if(!anyNA(to_plo$numerical_order) & !anyNA(to_plo$user_friendly_set_name)){
                a <- forcats::fct_reorder(to_plo$user_friendly_set_name,
                                          desc(to_plo$numerical_order))
                to_plo$graph_set_name <- a
                
        # second: no NAs in numerical_order only: use set_id, but put it in order
        } else if (!anyNA(to_plo$numerical_order)) {
                b <- forcats::fct_reorder(to_plo$set_id,
                                          desc(to_plo$numerical_order))
                to_plo$graph_set_name <- b
            
                
        # last: if neither are given, just use set names but make them factors and reverse them so the first in the alphabet will be at the top
        } else {
                c <- factor(to_plo$set_id)
                d <- forcats::fct_relevel(c, rev)
                to_plo$graph_set_name <- d
        }
        
        
        
        # perform cumulative change calculations and get the correct SET order for the cumulative change graph (only using SET ID for now)
        cumu_temp <- calc_change_cumu(to_calc)
        set_temp <- cumu_temp$set
        if (!anyNA(to_plo$numerical_order)){
          mdat_sub <- select(to_plo, set_id, numerical_order)
          set_temp <- left_join(set_temp, mdat_sub) %>% 
            mutate(set_id = fct_reorder(set_id, numerical_order)) %>% 
            select(-numerical_order)
          }    
        

        # make the plots
        
        ### STAR WARS PLOT
        p <- ggplot() +
                geom_blank(data = to_plo, 
                           aes(x = graph_set_name, 
                               y = rate_full)) +
                geom_ribbon(aes(x = 0:(nrow(to_plo)+1), 
                                ymin = slr-slr_ci, 
                                ymax = slr+slr_ci), 
                            fill = "navyblue", 
                            alpha = 0.1) +
                geom_hline(aes(yintercept = slr), 
                           col = "navyblue", 
                           size = 1, 
                           alpha = 0.9) +
                geom_hline(aes(yintercept = 0), 
                           col = "gray70") +
                geom_errorbar(data = to_plo, 
                              aes(x = graph_set_name, 
                                  ymin = CI_low_full, 
                                  ymax = CI_high_full), 
                              col = "gray55", 
                              size = 1) +
                geom_point(data = to_plo, 
                           aes(x = graph_set_name, 
                               y = rate_full), 
                           size = 3, 
                           col = "red3") +
                theme_classic() + 
                labs(title = paste0(reserves[i], ", Elevation Change, 95% Confidence Intervals (LMM)"), 
                     subtitle = paste0("Local SLR in blue: ", 
                                       slr, " +/- ", 
                                       slr_ci, " mm/yr"), 
                     x = "SET", 
                     y = "Rate of change (mm/yr)") +
                coord_flip()
       
        # print and save the plot 
        print(p)
        filename <- paste0(reserves[i], "_summary_plot.png")
        out_path <- here::here("R_output", "figures", "summary_plots", filename)
        ggsave(filename = out_path, plot = p, width = 7, height = 5, units = "in")
        
        
        
        ### CUMULATIVE CHANGE GRAPH
        q <- plot_cumu_set(cumu_temp$set) +
          ggtitle(paste0(reserves[i], ", Cumulative Change since first reading"))
        
        # print and save it
        print(q)
        filename <- paste0(reserves[i], "_cumu_change_plot.png")
        out_path <- here::here("R_output", "figures", "cumu_change_plots", filename)
        ggsave(filename = out_path, plot = q, width = 7, height = 8, units = "in")
        
        
        
        ### MAPS
        
        # build the map - comparison to 0
        m0 <- leaflet(to_map,
                      options = leafletOptions(zoomControl = FALSE)) %>%
          ### base layer options
          addProviderTiles(leaflet::providers$Esri.WorldGrayCanvas) %>% 
          ### Compared to 0 
          addMarkers(icon = icon_nonsiga,
                     lng = ~long[to_map$dir_0 == "nonsig"],
                     lat = ~lat[to_map$dir_0 == "nonsig"]) %>%
          addMarkers(icon = icon_inc_siga,
                     lng = ~long[to_map$dir_0 == "inc_sig"],
                     lat = ~lat[to_map$dir_0 == "inc_sig"]) %>%
          addMarkers(icon = icon_dec_siga,
                     lng = ~long[to_map$dir_0 == "dec_sig"],
                     lat = ~lat[to_map$dir_0 == "dec_sig"]) %>% 
          addMarkers(icon = icon_inc_nonsiga,
                     lng = ~long[to_map$dir_0 == "inc_nonsig"],
                     lat = ~lat[to_map$dir_0 == "inc_nonsig"]) %>%  
          addMarkers(icon = icon_dec_nonsiga,
                     lng = ~long[to_map$dir_0 == "dec_nonsig"],
                     lat = ~lat[to_map$dir_0 == "dec_nonsig"]) %>% 
          ### dress up the map
          addScaleBar() %>%
          addLegend(title = "Compared to 0",
                    position = "bottomright",
                    colors = map_pal,
                    values = c(1:length(map_pal)),
                    labels = c("lower; CIs don't overlap", "higher; CIs don't overlap", "CIs overlap"),
                    opacity = 0.8) 
        
        # save it out
        file_name <- paste0(reserves[i], "_map0.png")
        file_path1 <- here::here("R_output", "figures", "maps", file_name)
        mapview::mapshot(m0, file = file_path1)
        
        # pull in the image and print it
        knitr::include_graphics(file_path1)
        
        
        
        
        # build the map - comparison to SLR
        mSLR <- leaflet(to_map,
                        options = leafletOptions(zoomControl = FALSE)) %>%
          ### base layer options
          addProviderTiles(leaflet::providers$Esri.WorldGrayCanvas) %>% 
          ### Compared to SLR 
          addMarkers(icon = icon_nonsiga,
                     lng = ~long[to_map$dir_slr == "nonsig"],
                     lat = ~lat[to_map$dir_slr == "nonsig"]) %>%
          addMarkers(icon = icon_inc_siga,
                     lng = ~long[to_map$dir_slr == "inc_sig"],
                     lat = ~lat[to_map$dir_slr == "inc_sig"]) %>%
          addMarkers(icon = icon_dec_siga,
                     lng = ~long[to_map$dir_slr == "dec_sig"],
                     lat = ~lat[to_map$dir_slr == "dec_sig"]) %>% 
          addMarkers(icon = icon_inc_nonsiga,
                     lng = ~long[to_map$dir_slr == "inc_nonsig"],
                     lat = ~lat[to_map$dir_slr == "inc_nonsig"]) %>%  
          addMarkers(icon = icon_dec_nonsiga,
                     lng = ~long[to_map$dir_slr == "dec_nonsig"],
                     lat = ~lat[to_map$dir_slr == "dec_nonsig"]) %>% 
          ### dress up the map
          addScaleBar() %>%
          addLegend(title = "Compared to Sea Level Rise",
                    position = "bottomright",
                    colors = map_pal,
                    values = c(1:length(map_pal)),
                    labels = c("lower; CIs don't overlap", "higher; CIs don't overlap", "CIs overlap"),
                    opacity = 0.8) 
        
        # save it out
        file_name <- paste0(reserves[i], "_mapSLR.png")
        file_path2 <- here::here("R_output", "figures", "maps", file_name)
        mapview::mapshot(mSLR, file = file_path2)
        
        # pull in the image and print it
        # knitr::include_graphics(file_path2)
        
}

```

